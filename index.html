<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnet de Vol - V49.9.52</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2965/2965313.png">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('PWA active !'))
                    .catch(err => console.error('Erreur PWA', err));
            });
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --danger: #ea4335; --dark: #202124; --grey: #5f6368; --orange: #ff9800; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f0f2f5; padding: 10px; margin: 0; overflow-x: hidden; }
        .container { max-width: 650px; margin: auto; background: white; padding: 12px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; }
        #customModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .header-logo { text-align: center; margin-bottom: 5px; }
        .drone-icon { width: 50px; height: 50px; fill: var(--primary); }
        .app-title { text-align: center; font-size: 1.2rem; font-weight: 800; color: var(--dark); margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
        .live-clock { text-align: center; font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #333; background: #e8f0fe; padding: 8px; border-radius: 12px; margin-bottom: 15px; border: 2px solid var(--primary); }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 25px; border-radius: 30px; color: white; font-weight: bold; z-index: 9999; opacity: 0; transition: 0.4s; pointer-events: none; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; }
        #toast.show { opacity: 1; top: 40px; }
        .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-modal { border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .drone-selector-bar { display: flex; gap: 8px; overflow-x: auto; padding: 5px 0 15px 0; margin-bottom: 15px; scrollbar-width: none; border-bottom: 1px solid #eee; -webkit-overflow-scrolling: touch; }
        .drone-pill { background: #eee; padding: 10px 20px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .drone-pill.active { background: var(--primary); color: white; }
        .battery-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(105px, 1fr)); gap: 8px; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 12px; border: 1px solid #ddd; }
        .bat-box { background: white; padding: 10px 5px; text-align: center; border-radius: 10px; border: 1.5px solid #ddd; }
        .bat-box b { display: block; font-size: 0.9rem; color: var(--primary); margin-bottom: 4px; }
        .bat-box .last-time-badge { display: block; margin-top: 6px; background: #ffebee; color: #d32f2f; font-weight: 900; font-size: 0.85rem; padding: 4px 0; border-radius: 6px; border: 1px solid #ffcdd2; min-height: 20px; }
        form { display: flex; flex-direction: column; gap: 12px; background: #f9f9f9; padding: 12px; border-radius: 15px; border: 1px solid #eee; }
        .row-split { display: flex; gap: 10px; flex-wrap: wrap; }
        .field { flex: 1; min-width: 140px; display: flex; flex-direction: column; }
        label { font-size: 0.65rem; font-weight: bold; color: var(--grey); margin-bottom: 4px; text-transform: uppercase; }
        input, select { height: 45px; border-radius: 8px; border: 1px solid #ddd; padding: 0 8px; font-size: 0.9rem; background: white; width: 100%; box-sizing: border-box; }
        .main-btn { color: white; border: none; height: 55px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; cursor: pointer; width: 100%; text-transform: uppercase; }
        #map { height: 120px; border-radius: 10px; margin-top: 8px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; font-size: 0.65rem; margin-top: 10px; }
        th { text-align: left; padding: 8px; background: #f4f4f4; border-bottom: 2px solid #ddd; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.55rem; font-weight: bold; color: white; text-transform: uppercase; }
        .footer-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 20px; }
        .btn-pdf-highlight { background: var(--orange) !important; color: white !important; height: 60px !important; font-size: 1rem !important; grid-column: span 2; border-radius: 12px; border:none; font-weight: bold; }
    </style>
</head>
<body>

<div id="toast"></div>

<div id="customModal">
    <div class="modal-content">
        <h3 id="modalTitle">üóëÔ∏è CONFIRMATION</h3>
        <p id="modalMsg"></p>
        <div class="modal-btns">
            <button class="btn-modal" onclick="closeModal()">ANNULER</button>
            <button id="modalConfirmBtn" class="btn-modal" style="background:var(--danger); color:white;">CONFIRMER</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header-logo">
        <svg class="drone-icon" viewBox="0 0 24 24"><path d="M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L5.32,7.91L12,11.66L18.68,7.91L12,4.15M5,15.91L11,19.29V12.69L5,9.31V15.91M19,15.91V9.31L13,12.69V19.29L19,15.91Z" /></svg>
    </div>
    <h1 class="app-title">Carnet de Vol Num√©rique</h1>
    <div class="live-clock" id="liveClock">00:00:00</div>
    <div class="drone-selector-bar" id="droneFilter"></div>
    <div id="batteryStats" class="battery-grid"></div>

    <form id="flightForm">
        <div class="row-split">
            <div class="field">
                <label>Appareil</label>
                <select id="droneSelect" required onchange="handleDroneChange(this.value)">
                    <option value="MAVIC 3">MAVIC 3</option>
                    <option value="MAVIC 4T">MAVIC 4T</option>
                    <option value="MAVIC 4TD">MAVIC 4TD</option>
                    <option value="AVATA">AVATA</option>
                    <option value="M30">DJI M30</option>
                    <option value="AUTEL 4T">AUTEL 4T</option>
                    <option value="MAVIC 2">MAVIC 2</option>
                    <option value="AUTRE">‚ûï AJOUTER AUTRE</option>
                </select>
                <input type="text" id="otherDroneInput" style="display:none; margin-top:5px;" placeholder="NOM DU DRONE..." oninput="syncOtherDrone(this.value)">
            </div>
            <div class="field"><label>Batterie</label><select id="batterySelect" required></select></div>
        </div>
        <div class="row-split">
            <div class="field"><label>Date</label><input type="date" id="date" required></div>
            <div class="field"><label>Type de Vol</label><select id="flightType" required><option value="MISSION">MISSION</option><option value="ENTRA√éNEMENT">ENTRA√éNEMENT</option><option value="AUTRE">AUTRE</option></select></div>
        </div>
        <div class="field">
            <label>Lieu (Rue + Ville)</label>
            <div style="display:flex; gap:5px;"><input type="text" id="gps" style="flex:1;" placeholder="Recherche adresse..."><button type="button" onclick="getLocation()" id="btnGps" style="width:45px; background:var(--primary); color:white; border:none; border-radius:8px;">üìç</button></div>
            <div id="map"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button type="button" class="main-btn" style="background:var(--success)" onclick="capture('start')">D√âCOLLAGE</button>
            <button type="button" class="main-btn" style="background:var(--danger)" onclick="capture('end')">ATTERRISSAGE</button>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:5px;">
            <div class="field"><label>D√©collage</label><div class="time-select-group"><select id="h-start" required></select><select id="m-start" required></select></div></div>
            <div class="field"><label>Atterrissage</label><div class="time-select-group"><select id="h-end" required></select><select id="m-end" required></select></div></div>
        </div>
        <button type="submit" class="main-btn" style="background:var(--primary)">üíæ ENREGISTRER LE VOL</button>
    </form>

    <div style="font-size: 0.75rem; font-weight: 800; color: var(--grey); margin: 20px 0 5px 0; border-left: 3px solid var(--grey); padding-left: 8px;">HISTORIQUE R√âCENT (3 DERNIERS)</div>
    <table id="logTable">
        <thead><tr><th>Drone</th><th>Type</th><th>Heure</th><th>Lieu</th><th></th></tr></thead>
        <tbody id="logBody"></tbody>
    </table>

    <div class="footer-actions">
        <button class="btn-pdf-highlight" onclick="generateFullPDF()">üìÑ PDF + STATS D√âTAILL√âES</button>
        <button onclick="exportJSON()">üì§ SAUVEGARDE</button>
        <button onclick="document.getElementById('importFile').click()">üì• RESTAURATION</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importJSON(event)">
    </div>
</div>

<script>
    const STORAGE_KEY = 'LOGBOOK_V49_FINAL';
    let flights = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let currentFilter = 'MAVIC 3';
    let map;

    function showNotify(msg, color="var(--primary)") {
        const t = document.getElementById('toast');
        t.innerText = msg; t.className = 'show'; t.style.background = color;
        setTimeout(() => { t.className = ''; }, 3000);
    }

    function showModal(title, msg, onConfirm) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMsg').innerText = msg;
        const confirmBtn = document.getElementById('modalConfirmBtn');
        confirmBtn.onclick = () => { onConfirm(); closeModal(); };
        document.getElementById('customModal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('customModal').style.display = 'none'; }

    async function getLocation() {
        const btn = document.getElementById('btnGps');
        if (navigator.geolocation) {
            btn.innerText = "‚è≥";
            navigator.geolocation.getCurrentPosition(async p => {
                const lat = p.coords.latitude, lng = p.coords.longitude;
                map.setView([lat, lng], 15); L.marker([lat, lng]).addTo(map);
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                    const data = await response.json();
                    if(data.address) {
                        const street = data.address.road || data.address.pedestrian || "";
                        const city = data.address.city || data.address.town || data.address.village || "";
                        let finalAddr = street;
                        if(city) finalAddr += (street ? ", " : "") + city;
                        document.getElementById('gps').value = finalAddr || `${lat.toFixed(4)},${lng.toFixed(4)}`;
                    }
                } catch (e) { document.getElementById('gps').value = `${lat.toFixed(4)},${lng.toFixed(4)}`; }
                btn.innerText = "üìç";
            }, () => { btn.innerText = "üìç"; });
        }
    }

    function capture(type) {
        const now = new Date();
        document.getElementById(`h-${type}`).value = String(now.getHours()).padStart(2, '0');
        document.getElementById(`m-${type}`).value = String(now.getMinutes()).padStart(2, '0');
        if(type === 'start') showNotify("üöÄ D√âCOLLAGE FIX√â", "var(--success)");
        else showNotify("üõ¨ ATTERRISSAGE FIX√â", "var(--danger)");
    }

    function updateUI() {
        const logBody = document.getElementById('logBody');
        const batStats = document.getElementById('batteryStats');
        const droneFilter = document.getElementById('droneFilter');
        logBody.innerHTML = ''; batStats.innerHTML = '';
        
        let dronesList = ["MAVIC 3", "MAVIC 4T", "MAVIC 4TD", "AVATA", "M30", "AUTEL 4T", "MAVIC 2"];
        flights.forEach(f => { if(!dronesList.includes(f.drone)) dronesList.push(f.drone); });

        let batUsage = {};
        flights.forEach(f => {
            if (f.drone === currentFilter) {
                if(!batUsage[f.battery]) batUsage[f.battery] = 0;
                batUsage[f.battery]++;
            }
        });

        Object.keys(batUsage).forEach(b => {
            batStats.innerHTML += `<div class="bat-box"><b>${b}</b><div>${batUsage[b]} vols</div></div>`;
        });

        [...flights].reverse().slice(0, 3).forEach((f, idx) => {
            logBody.innerHTML += `<tr><td><b>${f.drone}</b></td><td>${f.type}</td><td>${f.hStart}:${f.mStart}</td><td>${f.gps || '-'}</td><td><button onclick="deleteFlight(${idx})">‚úñ</button></td></tr>`;
        });

        droneFilter.innerHTML = '';
        dronesList.forEach(d => {
            droneFilter.innerHTML += `<div class="drone-pill ${currentFilter===d?'active':''}" onclick="setFilter('${d}')">${d}</div>`;
        });
    }

    function setFilter(d) { currentFilter = d; updateUI(); }

    function generateFullPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const now = new Date();
        const rows = [...flights].reverse().map(f => [f.drone, f.type, f.date, f.battery, `${f.hStart}:${f.mStart}`, f.gps]);
        doc.text("CARNET DE VOL - HISTORIQUE", 14, 20);
        doc.autoTable({ startY: 30, head: [['Drone', 'Type', 'Date', 'Bat', 'Heure', 'Lieu']], body: rows });
        doc.save(`Vols_${now.toISOString().split('T')[0]}.pdf`);
    }

    document.getElementById('flightForm').onsubmit = (e) => {
        e.preventDefault();
        flights.push({
            drone: document.getElementById('droneSelect').value,
            battery: document.getElementById('batterySelect').value,
            type: document.getElementById('flightType').value,
            date: document.getElementById('date').value,
            gps: document.getElementById('gps').value,
            hStart: document.getElementById('h-start').value,
            mStart: document.getElementById('m-start').value,
            hEnd: document.getElementById('h-end').value,
            mEnd: document.getElementById('m-end').value
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(flights));
        updateUI(); showNotify("üíæ VOL ENREGISTR√â ‚úÖ");
    };

    function exportJSON() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(flights));
        const a = document.createElement('a'); a.href = data; a.download = "sauvegarde.json"; a.click();
    }

    function initTimeSelectors() {
        const hs = document.querySelectorAll('#h-start, #h-end');
        const ms = document.querySelectorAll('#m-start, #m-end');
        hs.forEach(s => { for(let i=0; i<24; i++) s.innerHTML += `<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}h</option>`; });
        ms.forEach(s => { for(let i=0; i<60; i++) s.innerHTML += `<option value="${String(i).padStart(2,'0')}">${String(i).padStart(2,'0')}m</option>`; });
    }

    window.onload = () => {
        initTimeSelectors();
        const selBat = document.getElementById('batterySelect');
        for(let i=1; i<=20; i++) selBat.innerHTML += `<option value="B${i}">BATTERIE ${i}</option>`;
        document.getElementById('date').valueAsDate = new Date();
        map = L.map('map', {zoomControl: false}).setView([46.6, 1.8], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        updateUI();
        setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('fr-FR'); }, 1000);
    };
</script>
</body>
</html>
